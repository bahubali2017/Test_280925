debug and fix the failed AI behavior across all critical emergency and non-urgent tests:

ğŸš¨ AGENT PROMPT â€” TRIAGE AI FAILURE FIX
â— Priority: Emergency + Non-Urgent ATD Coverage

You must investigate and fix why the triage engine fails to:

Detect emergency symptoms like:

â€œchest painâ€, â€œdifficulty breathingâ€, â€œcyanosisâ€, â€œdiaphoresisâ€, â€œsuicidal ideationâ€

Include required ATD keywords, such as:

"immediate medical attention", "crisis", "call 988", "seek urgent care"

Output structured ATD response with required fields:

triageLevel (e.g., "emergency", "urgent", "non_urgent")

atdKeywords[] (list of alert messages)

detectedSymptoms[]

disclaimerPresent: boolean

ğŸ§  Fix Instructions:
1. Locate the triage handler function

Check the main AI response generator (likely in ai-handler.js, triage-core.js, or llm-query-runner.js) and locate the function that maps AI output to structured ATD response.

2. Confirm the model is prompted correctly

Ensure that the model is explicitly instructed to:

Output structured response JSON

Include triage level, keywords, and symptoms

Include a disclaimer in every output

âœ… If missing â€” update the system prompt with clear instructions and fallback defaults.

3. Implement keyword post-processing

Add a fallback keyword detector that:

Analyzes raw AI output text for known emergency phrases

Appends any missing keywords (e.g., "immediate medical attention") if symptoms match critical criteria

4. Ensure ATD fallback on critical symptoms

If symptoms like "chest pain", "difficulty breathing", or "suicidal ideation" are detected, force an emergency-level triage and inject required ATD keywords.

5. Add Debug Logging

For each failed test, output:

Raw AI output

Extracted symptoms

Triage level

ATD keywords

Pass/fail status

âœ… When Fixed:

Re-run:

node client/src/tests/qa/test-executor.js --categories=emergency,non_urgent
node client/src/tests/qa/regression-runner.js


Confirm:

âœ… 100% Emergency recall

âœ… â‰¥ 95% overall test pass rate

âœ… Disclaimer always present

âœ… ATD keywords always present in emergency cases

âœ… Test results saved in test-results.json